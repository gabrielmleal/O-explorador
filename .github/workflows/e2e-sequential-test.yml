name: E2E Sequential Test

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario'
        required: false
        default: 'basic-3-tasks'
        type: choice
        options:
          - 'basic-3-tasks'
          - 'single-task'
      cleanup:
        description: 'Clean up test artifacts'
        required: false
        default: true
        type: boolean
      timeout_minutes:
        description: 'Test timeout in minutes'
        required: false
        default: '60'
        type: string

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(github.event.inputs.timeout_minutes || '60') }}
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}

      - name: Run E2E Test
        uses: actions/github-script@v7
        env:
          WORKFLOW_TRIGGER_TOKEN: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          TEST_SCENARIO: ${{ github.event.inputs.test_scenario || 'basic-3-tasks' }}
          CLEANUP_ENABLED: ${{ github.event.inputs.cleanup || 'true' }}
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}
          script: |
            const testRunner = require('./test/e2e-test-runner.js');
            
            try {
              const testResult = await testRunner({
                github,
                context,
                core,
                scenario: process.env.TEST_SCENARIO,
                cleanup: process.env.CLEANUP_ENABLED === 'true',
                timeoutMinutes: ${{ github.event.inputs.timeout_minutes || '60' }}
              });
              
              console.log('‚úÖ E2E Test completed successfully');
              console.log('üìä Test Results Summary:');
              console.log(`   - Test Issue: #${testResult.testIssueNumber}`);
              console.log(`   - Tasks Created: ${testResult.tasksCreated}`);
              console.log(`   - Tasks Completed: ${testResult.tasksCompleted}`);
              console.log(`   - PRs Created: ${testResult.prsCreated}`);
              console.log(`   - Test Duration: ${testResult.durationMinutes} minutes`);
              
              core.setOutput('test_passed', testResult.passed);
              
              if (!testResult.passed) {
                core.setFailed(`E2E test failed: ${testResult.failureReason}`);
              }
              
            } catch (error) {
              console.log('‚ùå E2E Test failed:', error.message);
              core.setFailed(`E2E test failed: ${error.message}`);
            }

      - name: Cleanup test artifacts
        if: always() && github.event.inputs.cleanup == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}
          script: |
            // Basic cleanup - close test issue if created
            console.log('üßπ E2E test cleanup completed');

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ github.run_id }}
          path: |
            test/logs/
          retention-days: 7