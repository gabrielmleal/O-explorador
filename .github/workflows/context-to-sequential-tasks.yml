name: Context to Sequential Tasks

on:
  workflow_dispatch:
    inputs:
      context:
        description: 'Project context or requirements to decompose into sequential tasks'
        required: true
        type: string
      max_tasks:
        description: 'Maximum number of tasks to create'
        required: false
        default: '10'
        type: string
  issues:
    types: [opened, edited]

jobs:
  setup-sequential-execution:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'sequential-context') && contains(github.event.issue.body, '@claude'))
    
    permissions:
      contents: write
      issues: write
      id-token: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}

      - name: Analyze context with Claude Code
        id: claude-decomposition
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: 20
          custom_instructions: |
            Create a file named `tasks.json` that breaks down the project requirement into 3-5 sequential implementation tasks.

            Project requirements:
            ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.context || github.event.issue.body }}

            Create tasks.json with this exact structure:
            ```json
            {
              "tasks": [
                {
                  "title": "Clear task title describing what to implement",
                  "body": "Detailed description of what to build/create/implement"
                }
              ]
            }
            ```

            Requirements:
            - 3-5 tasks maximum
            - Tasks build sequentially on each other
            - Focus on actual implementation, not planning
            - Use specific, actionable titles
          allowed_tools: "Write,Read,Edit"

      - name: Verify Claude Code Action execution
        if: always()
        run: |
          echo "ðŸ” Checking Claude Code Action execution status..."
          
          if [ "${{ steps.claude-decomposition.outcome }}" = "failure" ]; then
            echo "âŒ Claude Code Action failed during task decomposition"
            echo "This could be due to:"
            echo "  - Authentication token issues (CLAUDE_CODE_OAUTH_TOKEN)"
            echo "  - Network connectivity problems"
            echo "  - Claude Code service unavailability"
            echo "  - Complex or unclear project requirements"
            echo "  - Timeout exceeded (current: 20 minutes)"
            echo ""
            echo "ðŸ” Suggested fixes:"
            echo "  1. Verify CLAUDE_CODE_OAUTH_TOKEN is valid and has proper permissions"
            echo "  2. Simplify project requirements if they're too complex"
            echo "  3. Check Claude Code service status"
            echo "  4. Consider increasing timeout if requirements are extensive"
            exit 1
          elif [ "${{ steps.claude-decomposition.outcome }}" = "cancelled" ]; then
            echo "âš ï¸ Claude Code Action was cancelled during task decomposition"
            exit 1
          elif [ "${{ steps.claude-decomposition.outcome }}" = "success" ]; then
            echo "âœ… Claude Code Action completed successfully"
          else
            echo "âš ï¸ Claude Code Action completed with unknown status: ${{ steps.claude-decomposition.outcome }}"
          fi

      - name: Verify tasks.json creation
        if: always()
        run: |
          if [ ! -f "tasks.json" ]; then
            echo "âŒ tasks.json file was not created by Claude Code"
            echo "This could be due to:"
            echo "  - Claude Code authentication issues"
            echo "  - Complex or unclear project requirements"
            echo "  - Claude Code service unavailable"
            echo "  - Token permissions insufficient"
            echo "  - Invalid configuration parameters"
            echo ""
            echo "ðŸ” Troubleshooting steps:"
            echo "  1. Verify CLAUDE_CODE_OAUTH_TOKEN is set correctly"
            echo "  2. Check workflow logs for Claude Code Action errors"
            echo "  3. Ensure project requirements are clear and specific"
            echo "  4. Validate timeout settings are sufficient"
            exit 1
          else
            echo "âœ… tasks.json file created successfully"
            echo "ðŸ“‹ Contents:"
            cat tasks.json
            echo ""
            echo "ðŸ” Validating JSON structure..."
            if ! jq empty tasks.json 2>/dev/null; then
              echo "âŒ tasks.json contains invalid JSON"
              exit 1
            else
              echo "âœ… JSON structure is valid"
            fi
          fi

      - name: Setup sequential task execution
        id: setup-sequential
        uses: actions/github-script@v7
        env:
          PARENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
          WORKFLOW_TRIGGER_TOKEN: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}
          script: |
            const path = require('path');
            const setupSequentialTasks = require(path.join(process.cwd(), 'scripts', 'setup-sequential-tasks.js'));
            
            try {
              const result = await setupSequentialTasks({ github, context, core });
              
              console.log(`âœ… Sequential execution setup complete:`);
              console.log(`   - ${result.tasksCount} tasks prepared`);
              console.log(`   - State storage: ${result.stateStorage}`);
              console.log(`   - Parent issue: #${result.parentIssue}`);
              console.log(`   - First task triggered: ${result.firstTaskTriggered}`);
              
              core.setOutput('tasks_count', result.tasksCount);
              core.setOutput('first_task_triggered', result.firstTaskTriggered);
              
            } catch (error) {
              console.log('âŒ Sequential setup failed:', error.message);
              
              // Create error comment on parent issue if it exists
              const parentIssue = process.env.PARENT_ISSUE_NUMBER;
              if (parentIssue) {
                try {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(parentIssue),
                    body: `âŒ **Sequential Task Setup Failed**
            
            Error: ${error.message}
            
            Please check the context input and try again. Make sure:
            - Context is clear and well-defined
            - Claude Code OAuth token is properly configured
            - Repository has necessary permissions for sequential execution
            
            You can retry by re-running this workflow or creating a new issue with the \`sequential-context\` label.`
                  });
                } catch (commentError) {
                  console.log('Failed to create error comment:', commentError.message);
                }
              }
              
              core.setFailed(`Sequential setup failed: ${error.message}`);
            }

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sequential-task-setup
          path: |
            tasks.json
            current-task-context.json
          retention-days: 30

      - name: Create progress summary
        if: steps.setup-sequential.outputs.tasks_count && steps.setup-sequential.outputs.tasks_count > '0'
        uses: actions/github-script@v7
        with:
          script: |
            const tasksCount = '${{ steps.setup-sequential.outputs.tasks_count }}' || '0';
            const parentIssue = process.env.PARENT_ISSUE_NUMBER || context.payload.issue?.number;
            
            if (parentIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(parentIssue),
                body: `## âš¡ Sequential Task Execution In Progress
            
            ðŸŽ¯ **Setup Complete**: ${tasksCount} tasks created and ready for sequential execution
            ðŸš€ **Status**: Task 1 is now executing
            ðŸ“Š **Progress**: 1/${tasksCount} tasks started
            
            ### How Sequential Execution Works:
            
            1. **Sequential Processing**: Tasks execute one at a time, in order
            2. **Progressive Building**: Each task builds on changes from previous tasks  
            3. **Stacked PRs**: Each task creates a PR that includes its changes only
            4. **Automatic Chaining**: Next task triggers automatically when current completes
            5. **Full Context**: Later tasks have access to all previous implementations
            
            ### Monitor Progress:
            
            - Watch for PR creation notifications
            - Each PR will be labeled with \`sequential-task\` and \`task-N\`
            - Progress updates will be posted here automatically
            - Final completion summary will be posted when all tasks finish
            
            *Sequential execution is now running automatically...*`
              });
            } else {
              console.log(\`âœ… Sequential execution setup complete with \${tasksCount} tasks\`);
            }