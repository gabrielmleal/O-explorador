name: Sequential Task Executor

on:
  repository_dispatch:
    types: 
      - execute-sequential-task
  workflow_dispatch:
    inputs:
      task_index:
        description: 'Task index to execute (0-based)'
        required: true
        default: '0'
        type: string
      previous_branch:
        description: 'Previous branch to base from'
        required: false
        default: 'main'
        type: string
      parent_issue:
        description: 'Parent issue number'
        required: true
        type: string

jobs:
  execute-task:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}

      - name: Prepare task execution environment
        id: prepare-task
        uses: actions/github-script@v7
        env:
          WORKFLOW_TRIGGER_TOKEN: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}
          script: |
            const path = require('path');
            const executeSequentialTask = require(path.join(process.cwd(), 'scripts', 'execute-sequential-task.js'));
            
            try {
              // Debug information
              console.log('🔍 Workflow Debug Information:');
              console.log(`   - Event name: ${context.eventName}`);
              console.log(`   - Action: ${context.payload.action || 'N/A'}`);
              console.log(`   - Full payload:`, JSON.stringify(context.payload, null, 2));
              
              // Handle both repository_dispatch and workflow_dispatch events
              if (context.eventName === 'repository_dispatch') {
                console.log('📨 Triggered by repository_dispatch event');
                console.log(`   - Event type: ${context.payload.action}`);
                console.log(`   - Client payload:`, context.payload.client_payload);
              } else if (context.eventName === 'workflow_dispatch') {
                console.log('🖱️ Triggered by manual workflow_dispatch');
                console.log(`   - Inputs:`, context.payload.inputs);
                
                // For workflow_dispatch, we need to create a mock client_payload from inputs
                context.payload.client_payload = {
                  task_index: parseInt(context.payload.inputs.task_index || '0'),
                  previous_branch: context.payload.inputs.previous_branch || 'main',
                  parent_issue: parseInt(context.payload.inputs.parent_issue),
                  trigger_source: 'manual_workflow_dispatch'
                };
                console.log('   - Created client_payload from inputs:', context.payload.client_payload);
              } else {
                throw new Error(`Unsupported event type: ${context.eventName}. Expected repository_dispatch or workflow_dispatch.`);
              }
              
              const taskContext = await executeSequentialTask({ github, context, core });
              
              console.log('📋 Task execution context prepared:');
              console.log(`   - Task: ${taskContext.taskData.title}`);
              console.log(`   - Index: ${taskContext.taskIndex + 1}/${taskContext.totalTasks}`);
              console.log(`   - Branch: ${taskContext.currentBranch}`);
              console.log(`   - Base: ${taskContext.previousBranch}`);
              
              // Set outputs for next steps
              core.setOutput('task_title', taskContext.taskData.title);
              core.setOutput('task_index', taskContext.taskIndex.toString());
              core.setOutput('task_number', (taskContext.taskIndex + 1).toString());
              core.setOutput('total_tasks', taskContext.totalTasks.toString());
              core.setOutput('current_branch', taskContext.currentBranch);
              core.setOutput('previous_branch', taskContext.previousBranch);
              core.setOutput('task_prepared', 'true');
              
            } catch (error) {
              console.log('❌ Task preparation failed:', error.message);
              console.log('🔍 Full error details:', error);
              core.setFailed(`Task preparation failed: ${error.message}`);
            }

      - name: Implement task with Claude Code
        if: steps.prepare-task.outputs.task_prepared == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            @claude You are implementing Task ${{ steps.prepare-task.outputs.task_number }} of ${{ steps.prepare-task.outputs.total_tasks }} in a SEQUENTIAL task execution system.

            CRITICAL CONTEXT: This task builds on previous tasks' changes. You are currently working on branch ${{ steps.prepare-task.outputs.current_branch }} which was created from ${{ steps.prepare-task.outputs.previous_branch }}.

            Read current-task-context.json for complete context including:
            - Current task details  
            - Previous tasks that have been completed
            - Sequential execution context
            - Changes from previous tasks are already in your working directory

            TASK TO IMPLEMENT:
            **${{ steps.prepare-task.outputs.task_title }}**

            INSTRUCTIONS:
            1. Read CLAUDE.md for project guidelines
            2. Read current-task-context.json for full sequential context
            3. Examine existing code to understand previous tasks' implementations
            4. Implement this specific task building on existing changes
            5. Follow project conventions and best practices
            6. Create/modify all necessary files for this task
            7. Ensure code is production-ready with proper error handling
            8. Write tests if the project has testing infrastructure
            
            IMPORTANT: 
            - You're working with cumulative changes from previous tasks
            - Focus only on implementing this specific task
            - Build upon and integrate with existing code from previous tasks
            - Do not redo work from previous tasks unless necessary for integration
            - Your changes will be reviewed as part of a stacked PR system

      - name: Handle task completion
        if: steps.prepare-task.outputs.task_prepared == 'true'
        uses: actions/github-script@v7
        env:
          WORKFLOW_TRIGGER_TOKEN: ${{ secrets.WORKFLOW_TRIGGER_TOKEN }}
        with:
          github-token: ${{ secrets.WORKFLOW_TRIGGER_TOKEN || github.token }}
          script: |
            const path = require('path');
            const fs = require('fs');
            const executeSequentialTask = require(path.join(process.cwd(), 'scripts', 'execute-sequential-task.js'));
            
            try {
              // Load task context
              const taskContextFile = 'current-task-context.json';
              if (!fs.existsSync(taskContextFile)) {
                throw new Error('Task context file not found');
              }
              
              const taskContext = JSON.parse(fs.readFileSync(taskContextFile, 'utf8'));
              
              // Handle task completion (PR creation and next task triggering)
              const result = await executeSequentialTask.handleTaskCompletion({ 
                github, 
                context, 
                core, 
                taskContext 
              });
              
              if (result.status === 'completed') {
                console.log(`✅ Task ${taskContext.taskIndex + 1} completed successfully`);
                console.log(`📝 Created PR #${result.prNumber}`);
                
                core.setOutput('pr_number', result.prNumber);
                core.setOutput('task_status', 'completed');
                
              } else if (result.status === 'no-changes') {
                console.log(`⚠️ Task ${taskContext.taskIndex + 1} completed with no changes needed`);
                core.setOutput('task_status', 'no-changes');
                
              } else if (result.status === 'all_completed') {
                console.log('🎉 All sequential tasks have been completed!');
                core.setOutput('task_status', 'all_completed');
                core.setOutput('total_tasks_completed', result.tasksCompleted);
              }
              
            } catch (error) {
              console.log('❌ Task completion handling failed:', error.message);
              core.setFailed(`Task completion failed: ${error.message}`);
            }

      - name: Create progress update
        if: always() && steps.prepare-task.outputs.task_prepared == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { findStateComment } = require('./scripts/setup-sequential-tasks');
            
            try {
              // Get parent issue from dispatch payload
              const parentIssue = context.payload.client_payload?.parent_issue;
              
              if (parentIssue) {
                console.log(`📊 Creating progress update for issue #${parentIssue}`);
                
                // Load current state from issue comments
                const stateResult = await findStateComment(github, context.repo.owner, context.repo.repo, parentIssue);
                
                if (stateResult) {
                  const sequentialState = stateResult.state;
                  const completedTasks = sequentialState.tasks.filter(t => t.status === 'completed' || t.status === 'no-changes').length;
                  const totalTasks = sequentialState.tasks.length;
                  const currentTaskIndex = sequentialState.current_task_index || 0;
                  const currentTask = sequentialState.tasks[currentTaskIndex];
                  
                  let statusMessage;
                  if (sequentialState.status === 'completed') {
                    statusMessage = `🎉 **All tasks completed!** Final progress: ${totalTasks}/${totalTasks} tasks finished`;
                  } else if (sequentialState.status === 'failed') {
                    statusMessage = `❌ **Task failed:** ${currentTask?.title || 'Unknown task'} (Task ${currentTaskIndex + 1})`;
                  } else {
                    const nextTaskIndex = currentTaskIndex + 1;
                    if (nextTaskIndex < totalTasks) {
                      statusMessage = `⚡ **Progress Update:** Task ${currentTaskIndex + 1} completed, Task ${nextTaskIndex + 1} starting next`;
                    } else {
                      statusMessage = `✅ **Final Task:** Task ${currentTaskIndex + 1} was the last task`;
                    }
                  }
                  
                  const progressBars = sequentialState.tasks.map((task, i) => {
                    const status = task.status;
                    const icon = status === 'completed' ? '✅' : 
                               status === 'no-changes' ? '⚠️' : 
                               status === 'failed' ? '❌' : 
                               status === 'in-progress' ? '🔄' : '⏳';
                    const prLink = task.pr_number ? ` ([PR #${task.pr_number}](https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${task.pr_number}))` : '';
                    return `- ${icon} **Task ${i + 1}**: ${task.title}${prLink}`;
                  }).join('\n');
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parentIssue,
                    body: [
                      '## 📊 Sequential Task Progress Update',
                      '',
                      statusMessage,
                      '',
                      `**Current Status:** ${completedTasks}/${totalTasks} tasks completed`,
                      '',
                      '### Task Status:',
                      '',
                      progressBars,
                      '',
                      '---',
                      '*Updated automatically by Sequential Task Executor*'
                    ].join('\n')
                  });
                  
                  console.log('✅ Progress update created');
                } else {
                  console.log('⚠️ No sequential state found for progress update');
                }
              } else {
                console.log('⚠️ No parent issue found for progress update');
              }
            } catch (error) {
              console.log('Failed to create progress update:', error.message);
            }

      - name: Upload task artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sequential-task-${{ steps.prepare-task.outputs.task_number || 'unknown' }}-artifacts
          path: |
            current-task-context.json
          retention-days: 30