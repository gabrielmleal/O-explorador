name: Context to Tasks Orchestrator

on:
  workflow_dispatch:
    inputs:
      context:
        description: 'Project context or requirements to decompose'
        required: true
        type: string
      max_tasks:
        description: 'Maximum number of tasks to create'
        required: false
        default: '10'
        type: string
  issues:
    types: [opened, edited]

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  decompose-and-create-issues:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'context-input'))
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          echo "Installing dependencies from scripts/requirements.txt..."
          pip install -r scripts/requirements.txt || {
            echo "‚ùå Requirements file installation failed, installing packages individually..."
            pip install "anthropic>=0.35.0"
            pip install "PyGithub>=1.58.0"
            pip install "pyyaml>=6.0"
            pip install "requests>=2.28.0"
          }
          echo "Verifying installation..."
          pip list | grep -E "(anthropic|PyGithub|pyyaml|requests)" || echo "‚ö†Ô∏è Some packages may not be visible in pip list"
          echo "Testing critical imports..."
          python -c "import anthropic; print('‚úÖ anthropic SDK successfully imported')"
          python -c "import github; print('‚úÖ PyGithub successfully imported')"
      
      - name: Extract context
        id: extract_context
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "CONTEXT=${{ github.event.inputs.context }}" >> $GITHUB_ENV
            echo "MAX_TASKS=${{ github.event.inputs.max_tasks }}" >> $GITHUB_ENV
          else
            # Extract context from issue body
            echo "CONTEXT<<EOF" >> $GITHUB_ENV
            echo "${{ github.event.issue.body }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "MAX_TASKS=10" >> $GITHUB_ENV
            echo "PARENT_ISSUE=${{ github.event.issue.number }}" >> $GITHUB_ENV
          fi
      
      - name: Decompose context into tasks
        id: decompose
        run: |
          echo "=== Environment Debug ==="
          echo "Current directory: $(pwd)"
          echo "Python version: $(python --version)"
          echo "Python path: $(which python)"
          echo "PYTHONPATH: ${PYTHONPATH:-not set}"
          
          echo "=== Re-testing anthropic import ==="
          python -c "import anthropic; print('‚úÖ anthropic SDK available')" || {
            echo "‚ùå anthropic import failed, attempting reinstall..."
            pip install anthropic --force-reinstall --no-cache-dir
            python -c "import anthropic; print('‚úÖ anthropic SDK now available')" || {
              echo "‚ùå Critical error: Cannot import anthropic after reinstall"
              echo "Available packages:"
              pip list
              exit 1
            }
          }
          
          echo "=== Running task decomposer ==="
          python scripts/task-decomposer.py \
            --context "${{ env.CONTEXT }}" \
            --max-tasks "${{ env.MAX_TASKS }}" \
            --output tasks.json
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        continue-on-error: true
      
      - name: Create GitHub issues for tasks
        id: create_issues
        run: |
          python scripts/issue-creator.py \
            --tasks-file tasks.json \
            --repo "${{ github.repository }}" \
            --parent-issue "${{ env.PARENT_ISSUE }}" \
            --auto-implement true
        continue-on-error: true
      
      - name: Debug workflow files
        if: always()
        run: |
          echo "=== Workflow Debug Information ==="
          echo "Current directory: $(pwd)"
          echo "Available files:"
          ls -la
          echo ""
          echo "=== Task decomposition output ==="
          if [ -f "tasks.json" ]; then
            echo "‚úÖ tasks.json exists"
            echo "File size: $(wc -c < tasks.json) bytes"
            echo "Content preview:"
            head -20 tasks.json
          else
            echo "‚ùå tasks.json missing"
          fi
          echo ""
          echo "=== Issue creation output ==="
          if [ -f "created_issues.json" ]; then
            echo "‚úÖ created_issues.json exists" 
            echo "Content:"
            cat created_issues.json
          else
            echo "‚ùå created_issues.json missing"
          fi
          echo ""
          echo "=== Environment variables ==="
          echo "PARENT_ISSUE: ${{ env.PARENT_ISSUE }}"
          echo "CONTEXT length: ${#CONTEXT}"
      
      - name: Post summary comment
        if: env.PARENT_ISSUE != '' && (steps.create_issues.outcome == 'success' || steps.create_issues.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check if required files exist
            if (!fs.existsSync('tasks.json')) {
              console.log('‚ùå tasks.json not found - task decomposition may have failed');
              return;
            }
            
            if (!fs.existsSync('created_issues.json')) {
              console.log('‚ùå created_issues.json not found - issue creation may have failed');
              return;
            }
            
            const tasks = JSON.parse(fs.readFileSync('tasks.json', 'utf8'));
            const issueNumbers = JSON.parse(fs.readFileSync('created_issues.json', 'utf8'));
            
            if (!issueNumbers || issueNumbers.length === 0) {
              console.log('‚ö†Ô∏è No issues were created');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: process.env.PARENT_ISSUE,
                body: '## ü§ñ Task Decomposition Complete\n\n‚ö†Ô∏è No implementation tasks were created. This could be due to:\n- Empty or invalid context\n- Task decomposition errors\n- GitHub API issues\n\nPlease check the workflow logs for details.'
              });
              return;
            }
            
            let comment = '## ü§ñ Task Decomposition Complete\n\n';
            comment += `Created ${issueNumbers.length} implementation tasks:\n\n`;
            
            issueNumbers.forEach((issueNum, idx) => {
              const taskTitle = tasks.tasks && tasks.tasks[idx] ? tasks.tasks[idx].title : `Task ${idx + 1}`;
              comment += `- [ ] #${issueNum}: ${taskTitle}\n`;
            });
            
            comment += '\n---\n*Each task will automatically trigger Claude to create a PR.*';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: process.env.PARENT_ISSUE,
              body: comment
            });
      
      - name: Upload task artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-decomposition
          path: |
            tasks.json
            created_issues.json