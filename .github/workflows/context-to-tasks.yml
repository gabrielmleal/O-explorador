name: Context to Tasks Orchestrator

on:
  workflow_dispatch:
    inputs:
      context:
        description: 'Project context or requirements to decompose'
        required: true
        type: string
      max_tasks:
        description: 'Maximum number of tasks to create'
        required: false
        default: '10'
        type: string
  issues:
    types: [opened, edited]

jobs:
  decompose-and-create-issues:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'context-input'))
    
    permissions:
      contents: read
      issues: write
      id-token: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Analyze context with Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            Read CLAUDE.md and break down this context into implementable tasks:

            ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.context || github.event.issue.body }}

            Create tasks.json with structure:
            {
              "tasks": [{"title": "...", "body": "..."}],
              "parent_issue": ${{ github.event.issue.number || null }}
            }

            Max tasks: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.max_tasks || '10' }}

      - name: Create GitHub issues from tasks
        uses: actions/github-script@v7
        env:
          PARENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const path = require('path');
            const createIssues = require(path.join(process.cwd(), 'scripts', 'create-issues.js'));
            
            try {
              await createIssues({ github, context, core });
            } catch (error) {
              console.log('‚ùå Issue creation failed:', error.message);
              core.setFailed(error.message);
            }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-decomposition
          path: |
            tasks.json
            created_issues.json